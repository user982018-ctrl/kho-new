<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>B·∫£ng ƒë∆°n h√†ng ‚Üí JSON</title>
<style>
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #e5e7eb;padding:8px}
  thead th{background:#2563eb;color:#fff}
  tfoot td{background:#f8fafc}
  input[type="checkbox"]{width:18px;height:18px;accent-color:#2563eb}
  input[type="number"], input[type="text"]{width:100%;box-sizing:border-box}
  .right{text-align:right}
  .save{position:fixed;right:28px;bottom:28px;padding:12px 18px;border:0;border-radius:10px;background:#4f46e5;color:#fff;cursor:pointer}
  pre{background:#0b1020;color:#d1e0ff;padding:12px;border-radius:8px;max-height:260px;overflow:auto}
</style>
</head>
<body>

<table id="orderTable">
  <thead>
    <tr>
      <th>S·∫£n ph·∫©m</th>
      <th>Qu√†</th>
      <th class="right">ƒê∆°n gi√°</th>
      <th class="right">S·ªë l∆∞·ª£ng</th>
      <th class="right">Th√†nh ti·ªÅn</th>
      <th></th>
    </tr>
  </thead>
  <tbody id="items">
    <!-- M·ªói d√≤ng d·ªØ li·ªáu c·∫ßn class item-row (c√≥ th·ªÉ th√™m data-id s·∫£n ph·∫©m n·∫øu mu·ªën) -->
    <tr class="item-row" data-id="P001">
      <td class="name">Si√™u l·ªõn tr√°i</td>
      <td class="right"><input type="checkbox" class="gift" checked></td>
      <td class="right"><input type="text" class="price" value="120,000"></td>
      <td class="right"><input type="number" class="qty" value="2" min="0"></td>
      <td class="right"><span class="amount">240,000</span></td>
      <td class="right">üóëÔ∏è</td>
    </tr>

    <tr class="item-row" data-id="P002">
      <td class="name">1kg Humic</td>
      <td class="right"><input type="checkbox" class="gift" checked></td>
      <td class="right"><input type="text" class="price" value="120,000"></td>
      <td class="right"><input type="number" class="qty" value="1" min="0"></td>
      <td class="right"><span class="amount">120,000</span></td>
      <td class="right">üóëÔ∏è</td>
    </tr>

    <tr class="item-row" data-id="P003">
      <td class="name">ƒê·∫°m t√¥m 20l</td>
      <td class="right"><input type="checkbox" class="gift"></td>
      <td class="right"><input type="text" class="price" value="1,675,000"></td>
      <td class="right"><input type="number" class="qty" value="1" min="0"></td>
      <td class="right"><span class="amount">1,675,000</span></td>
      <td class="right">üóëÔ∏è</td>
    </tr>
  </tbody>

  <tfoot>
    <tr>
      <td colspan="3"></td>
      <td class="right"><label><input type="checkbox" id="promo"> Khuy·∫øn m√£i</label></td>
      <td class="right" id="grandTotal" style="color:#dc2626;font-weight:700">2,880,000</td>
      <td></td>
    </tr>
  </tfoot>
</table>

<button class="save" id="saveBtn">L∆∞u</button>

<h3>JSON xu·∫•t ra</h3>
<pre id="out"></pre>

<script>
  // --- Helpers ---
  const parseCurrency = (v) => {
    if (v == null) return 0;
    // VND: b·ªè m·ªçi k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
    const digits = String(v).replace(/[^\d]/g, '');
    return digits ? Number(digits) : 0;
  };
  const formatCurrency = (n) => n.toLocaleString('vi-VN');

  // (Tu·ª≥ ch·ªçn) C·∫≠p nh·∫≠t th√†nh ti·ªÅn m·ªói khi ƒë·ªïi gi√°/SL
  document.querySelectorAll('#items .item-row').forEach(tr => {
    const priceEl = tr.querySelector('.price');
    const qtyEl   = tr.querySelector('.qty');
    const amtEl   = tr.querySelector('.amount');

    function recalc() {
      const amount = parseCurrency(priceEl.value) * Number(qtyEl.value || 0);
      amtEl.textContent = formatCurrency(amount);
      updateGrandTotal();
    }
    priceEl.addEventListener('input', recalc);
    qtyEl.addEventListener('input', recalc);
  });

  function updateGrandTotal() {
    const total = Array.from(document.querySelectorAll('#items .item-row .amount'))
      .reduce((s, el) => s + parseCurrency(el.textContent), 0);
    document.getElementById('grandTotal').textContent = formatCurrency(total);
  }

  // --- L·∫•y t·∫•t c·∫£ d√≤ng => JSON khi nh·∫•n L∆∞u ---
  function tableToJSON() {
    const rows = Array.from(document.querySelectorAll('#items .item-row'));
    const items = rows.map((tr, idx) => {
      const id    = tr.dataset.id || null;
      const name  = tr.querySelector('.name')?.textContent.trim() || '';
      const gift  = tr.querySelector('.gift')?.checked || false;
      const price = parseCurrency(tr.querySelector('.price')?.value
                   ?? tr.querySelector('.price')?.textContent);
      const qty   = Number(tr.querySelector('.qty')?.value || 0);
      const amount = price * qty; // ho·∫∑c parse t·ª´ .amount n·∫øu b·∫°n mu·ªën gi·ªØ nguy√™n
      return { id, name, gift, unitPrice: price, quantity: qty, amount };
    });

    const payload = {
      promo: document.getElementById('promo').checked,
      items,
      subtotal: items.reduce((s,i)=>s+i.amount,0)
    };
    return payload;
  }

  document.getElementById('saveBtn').addEventListener('click', () => {
    const payload = tableToJSON();
    // Hi·ªÉn th·ªã
    document.getElementById('out').textContent = JSON.stringify(payload, null, 2);

    // (Tu·ª≥ ch·ªçn) G·ª≠i v·ªÅ server:
    // fetch('/api/orders/save', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify(payload)
    // });
  });
</script>
</body>
</html>
